<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>

    <style>
    h1 {
    	text-align: center;
    }

    .subtitle {
    	text-align: center;
    }

    </style>
    <script type="text/javascript">  

      function draw(geo_data) {
        "use strict";
        var margin = 75,
            width = 1000 - margin,
            height = 600 - margin;

        var svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin)
            .attr("height", height + margin)
            .append('g')
            .attr('class', 'map');

        var chart_svg = d3.select("body")
        	.append("svg")
        	.attr("width", width + margin)
        	.attr("height", height + margin)

        var projection = d3.geo.mercator()
                               .scale(140)
                               .translate([width / 2, height / 1.3]);

        var path = d3.geo.path().projection(projection);


        geo_data.features.forEach(function (d) {
        	d["id"] = d.properties["name"];
        })

        var map = svg.selectAll('path')
                     .data(geo_data.features, function (d) {
                     	return d["id"];
                     })
                     .enter()
                     .append('path')
                     .attr('d', path)
                     .style('fill', 'white')
                     .style('stroke', 'black')
                     .style('stroke-width', 0.5);

      d3.csv("data/song_rankings_1993_to_2015.csv", function(data) {

	      		var nested = d3.nest()
	      			.key(function(d) {
	      				return d['Country'];
	      			})
	      			.rollup(function(leaves) {
	      				return leaves.length;
	      			})
	      			.entries(data);

	      		//set the id property so we can correctly data bind by country name
	      		nested.forEach(function (d) {
	      			d["id"] = d["key"];
	      		});    		

	      		debugger;

	      		data.forEach(function (d) {
	      			d["Count"] = 1;
	      		})


      		  //plot the graph as well
            var myChart = new dimple.chart(chart_svg, data);
	          var x = myChart.addCategoryAxis("x", "Year");
	          x.addOrderRule("Date");
	          myChart.addMeasureAxis("y", "Count");
	          var s = myChart.addSeries("Country", dimple.plot.area);
	          myChart.addLegend(60, 10, 510, 20, "right");
	          myChart.draw();

      		function update_chart(selected_country){
      			//updates the current displaying chart to show only the selected country
      			myChart.data = data.filter(function (d) {
      				return d.Country == selected_country.key;
      			})
      			myChart.draw();
      		}


      		//create a color scale
      		var colorScale = d3.scale.linear()
		    	.domain(d3.extent(nested, function (d) {
		    		return d.values;
		    	}))
		    	.range(['grey','black']);


      		// http://stackoverflow.com/questions/9518186/manipulate-elements-by-binding-new-data
      		//set the fill of the countries based on the number of songs
      		svg.selectAll('path')
                 .data(nested, function (d) {
                 	return d["id"];
                 })
                 .style('fill', function(d) {
                 	return colorScale(d.values);
                 })
                 .on("mouseover", update_chart);


      });
    };
    </script>
  </head>
<body>
  <script type="text/javascript">
  /*
    Use D3 to load the GeoJSON file
    */
    
	d3.json("world_countries.json", draw);
  </script>
  <h1>Origins of the Songs in Australia's Hottest 100 Music Countdown</h1>
  <p class="subtitle">
  The Triple J Hottest 100 takes place every Australia day and is the largest musical democracy in the world.
	<br><br>
  Mouse over a country to see how many of their songs made the countdown since 1993. 
  </p>
</body>
</html>
