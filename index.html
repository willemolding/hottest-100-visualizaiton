<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>

    <style>
    h1 {
    	text-align: center;
    }

    .subtitle {
    	text-align: center;
    }

    .map-div {
    	float: left;
    }

    .chart-div {
    	float: left;
    }

    </style>
    <script type="text/javascript">  

      function draw(geo_data) {
        "use strict";
        var margin = 50,
            width = 700,
            height = 500,
            chart_width = 400,
            chart_height = 500;

        var svg = d3.select(".map-div")
            .append("svg")
            .attr("width", width + margin)
            .attr("height", height + margin)
            .append('g');

        var chart_svg = d3.select(".chart-div")
        	.append("svg")
        	.attr("width", chart_width + margin)
        	.attr("height", chart_height + margin)
        	.attr('class', 'chart');


        var projection = d3.geo.mercator()
                               .scale(120)
                               .translate([width / 2, height / 1.3]);

        var path = d3.geo.path().projection(projection);


        geo_data.features.forEach(function (d) {
        	d["id"] = d.properties["name"];
        })

        var map = svg.selectAll('path')
                     .data(geo_data.features, function (d) {
                     	return d["id"];
                     })
                     .enter()
                     .append('path')
                     .attr('d', path)
                     .style('fill', 'white')
                     .style('stroke', 'black')
                     .style('stroke-width', 0.5);

      d3.csv("data/song_rankings_1993_to_2015.csv", function(data) {

	      		var nested = d3.nest()
	      			.key(function(d) {
	      				return d['Country'];
	      			})
	      			.rollup(function(leaves) {
	      				return leaves.length;
	      			})
	      			.entries(data)
              .sort(function(a, b){ return d3.descending(a.values, b.values); });

	      		//set the id property so we can correctly data bind by country name
	      		nested.forEach(function (d) {
	      			d["id"] = d["key"];
	      		});    		

	      		data.forEach(function (d) {
	      			d["Number of Songs in Countdown"] = 1;
	      		})

            //create a version of the data where the countries other than the top 3 are listed as other.
            //This should make the area plot easier to read
            var top_countries = new Array;
            var number_of_top = 3;

            nested.slice(0,number_of_top).forEach(function (d) {
              top_countries.push(d.key);
            });

            //https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/create
            var data_top_only = data.map(function (d) {
              var new_d = Object.create(d);
              if(top_countries.indexOf(d.Country) == -1){
                new_d.Country = "Other";
              }
              return new_d;
            });

            debugger;

      		  //plot the graph as well
            var myChart = new dimple.chart(chart_svg, data_top_only);
            myChart.y = 100;
            myChart.height = chart_height - 200;
	          var x = myChart.addTimeAxis("x", "Year", null, "%Y");
	          x.addOrderRule("Date");
	          var y = myChart.addMeasureAxis("y", "Number of Songs in Countdown");
	          var s = myChart.addSeries("Country", dimple.plot.area);
	          myChart.addLegend(60, 10, chart_width, 100, "left");
	          myChart.draw();


	          // add a title to the chart
	          //http://stackoverflow.com/questions/25416063/title-for-charts-and-axes-in-dimple-js-charts
	          chart_svg.append("text")
	           .attr("id", "title")
					   .attr("x", myChart._xPixels() + myChart._widthPixels() / 2)
					   .attr("y", myChart._yPixels() - 20)
					   .style("text-anchor", "middle")
					   .style("font-family", "sans-serif")
					   .style("font-weight", "bold")
					   .text("");

					function show_default_chart(){
						myChart.data = data_top_only;
						chart_svg.select("#title")
      				.text("");
						myChart.draw();
					}


      		function update_chart(selected_country){
      			//updates the current displaying chart to show only the selected country
      			myChart.data = data.filter(function (d) {
      				return d.Country == selected_country.key;
      			})
      			chart_svg.select("#title")
      				.text(selected_country.key);
      			myChart.draw();

      		}


      		//create a color scale
      		var colorScale = d3.scale.linear()
		    	.domain(d3.extent(nested, function (d) {
		    		return d.values;
		    	}))
		    	.range(['lightBlue','darkBlue']);


      		// http://stackoverflow.com/questions/9518186/manipulate-elements-by-binding-new-data
      		//http://www.stator-afm.com/tutorial/d3-js-mouse-events/
      		//set the fill of the countries based on the number of songs
      		svg.selectAll('path')
                 .data(nested, function (d) {
                 	return d["id"];
                 })
                 .style('fill', function(d) {
                 	return colorScale(d.values);
                 })
                 .on("mouseover", update_chart)
                 .on("mouseout", show_default_chart);


      });
    };
    </script>
  </head>
<body>
  <script type="text/javascript">
  /*
    Use D3 to load the GeoJSON file
    */
    
	d3.json("data/world_countries.json", draw);
  </script>
  <h1>Origins of the Songs in Australia's Hottest 100 Music Countdown</h1>
  <p class="subtitle">
  The Triple J Hottest 100 is the largest musical democracy in the world.
	<br><br>
  Mouse over a country to see how many of their songs made the countdown every year since 1993
  </p>

  <div class = "map-div">
  </div>
  <div class = "chart-div">
  </div>
</body>
</html>
